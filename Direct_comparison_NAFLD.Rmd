---
title: "Direct NAFLD score comparison"
output: html_notebook
---

This notebook performs direct comparison between MPS datasets and human datasets
either by looking at correlations in gene expression, or by using a gene signature enrichment

# Load functions 

Libraries are called internally

```{r}
library(decoupleR)

dir_root <- "E:/Jose Luis/Documents/GitHub/FattyLiverModeling/"
source(paste0(dir_root,"utils/plotting_functions.R"))
source(paste0(dir_root,"modeling/functions_translation_jose.R"))

options(expressions = 5e5)

```

# Load datasets 

Load datasets and pre-process them to keep common genes. Data is log2 + 1 CPM transformed

```{r}
dataset_names <- c("Hoang", "Kostrzewski")
ref_dataset <- "Hoang"
# Load
data_list <- load_datasets(dataset_names, dir_data = paste0(dir_root,"data/"))
# Run PCA
tmp <- process_datasets(data_list, filter_variance = F)
data_list <- tmp$data_list
plt_list <- tmp$plt_list
# Define human and MPS data - using centered data is fine
data_human <- data_list$Hoang$data_center
Yh <- data_list$Hoang$metadata$nafld_activity_score
data_MPS <- data_list$Kostrzewski$data_center
```

# Naive model comparison

Look for enrichment of gene signatures from Hoang et al. Use VIPER to account for signs
(directionality) of the gene signatures

```{r}
# Gene signature set from Hoang et al
gNAS_signature <- c("ARPC5", "YWHAH", "ARF4", "TNFRSF12A", "ADHFE1", "USP33",
                    "CD52", "ACVR2B", "ING5", "ASB3", "IFI30", "ERVW-1", "YWHAZ",
                    "ERBB3", "KPNA2", "COQ10B", "MAGI1", "MAPRE1", "ABCA6")

# Sign of gene in signature
gNAS_signature_dir <- c(1,1,1,1,-1,-1,1,-1,-1,-1,1,-1,1,-1,1,1,-1,1,-1)

# Make a VIPER-like regulon based on the absolute sign of the genes in the regression model
NAFLD_net <- data.frame(source = "NAFLD", target = gNAS_signature, mor = gNAS_signature_dir)
rownames(NAFLD_net) <- NULL

# Score human dataset using the viper wrapper in decoupleR - seems to be a bug and doesn't run on full matrix, so just looping
NAFLD_viper_human <- NULL
for (ii in 1:ncol(data_human)){
  NAFLD_viper_human <- rbind(NAFLD_viper_human, 
                       run_viper(data_human[,ii], NAFLD_net, minsize = 5))
}
NAFLD_viper_human$condition <- colnames(data_human)  
  
# Score MPS dataset using the viper wrapper in decoupleR - seems to be a bug and doesn't run on full matrix, so just looping
NAFLD_viper_MPS <- NULL
for (ii in 1:ncol(data_MPS)){
  NAFLD_viper_MPS <- rbind(NAFLD_viper_MPS, 
                       run_viper(data_MPS[,ii], NAFLD_net, minsize = 5))
}
NAFLD_viper_MPS$condition <- colnames(data_MPS)  

# Visualize
plt_viper_human <- plot_scatter(x = Yh, y = NAFLD_viper_human$score, 
                                xlab = "NAS measured", ylab = "NAS enrichment score") +
                    geom_smooth(method = "lm", color = "indianred", linetype = 2, linewidth = size_line)


plt_viper_MPS <- data.frame(x = NAFLD_viper_MPS$score, data_list$Kostrzewski$metadata) %>%
              ggplot(aes(x = x, y = reorder(Combination_name, x), fill = NPC)) +
              geom_boxplot(size = size_col) +
              labs(x = "NAS enrichment score", y = NULL)
plt_viper_MPS <- add_theme(plt_viper_MPS) + facet_wrap(facets = vars(Background)) + scale_fill_brewer(palette = color_palette)
```


Now look at the NAS score of the human samples most similar to each MPS sample based on correlation

```{r}
# Initialize correlation matrix considering all genes, or only genes in NAS signature
cor_mat <- matrix(0, nrow = ncol(data_MPS), ncol = ncol(data_human))
rownames(cor_mat) <- colnames(data_MPS)
colnames(cor_mat) <- colnames(data_human)

cor_mat_sub <- cor_mat 

for (ii in 1:nrow(cor_mat)){
  for (jj in 1:ncol(cor_mat)){
    cor_mat[ii,jj] <- cor(data_MPS[,ii], data_human[,jj])
    cor_mat_sub[ii,jj] <- cor(data_MPS[gNAS_signature,ii], data_human[gNAS_signature,jj])
  }
}

# Get the NAFLD scores for the top 10 most correlated samples. Rank runs in ascending order, so we
# multiply by -1 to return descending order
NAFLD_cor_all <- matrix(0, nrow = nrow(cor_mat), ncol = 10)
rownames(NAFLD_cor_all) <- colnames(data_MPS)
NAFLD_cor_sub <- NAFLD_cor_all

for (ii in 1:nrow(NAFLD_cor_all)){
  NAFLD_cor_all[ii,] <- Yh[rank(-cor_mat[ii,]) <= 10]
  NAFLD_cor_sub[ii,] <- Yh[rank(-cor_mat_sub[ii,]) <= 10]
}

# Visualize the result of this correlation analysis
plt_cor_all <- data.frame(NAS = matrixStats::rowMedians(NAFLD_cor_all), data_list$Kostrzewski$metadata) %>%
              ggplot(aes(x = NAS, y = reorder(Combination_name, NAS), fill = NPC)) +
              geom_boxplot() +
              labs(x = "Median NAS of correlated samples", y = NULL)
plt_cor_all <- add_theme(plt_cor_all) + facet_wrap(facets = vars(Background)) + scale_fill_brewer(palette = color_palette)


plt_cor_sub <- data.frame(NAS = matrixStats::rowMedians(NAFLD_cor_sub), data_list$Kostrzewski$metadata) %>%
              ggplot(aes(x = NAS, y = reorder(Combination_name, NAS), fill = NPC)) +
              geom_boxplot() +
              labs(x = "Median NAS of correlated samples", y = NULL)
plt_cor_sub <- add_theme(plt_cor_sub) + facet_wrap(facets = vars(Background)) + scale_fill_brewer(palette = color_palette)

# Visualize as histograms: Plot histogram of NAS score from human data and the NAS score of correlated samples
plt_histo <- rbind(data.frame(source = "Human data", x = Yh), 
                   data.frame(source = "Correlation - all", x = matrixStats::rowMedians(NAFLD_cor_all)),
                   data.frame(source = "Correlation - sig", x = matrixStats::rowMedians(NAFLD_cor_sub))) %>%
              ggplot(aes(x = x, color = source)) +
                geom_freqpoly(bins = 7, size = size_line) +
                labs(x = "NAS", y = "Count", color = "Reference") 

plt_histo <- add_theme(plt_histo)

```